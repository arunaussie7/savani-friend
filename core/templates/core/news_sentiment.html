{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white py-16">
    <div class="container mx-auto px-4 text-center">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">News & Sentiment Analysis</h1>
        <p class="text-xl md:text-2xl opacity-90">Complete TradingView News Dashboard</p>
        <p class="text-lg opacity-80 mt-2">Real-time financial news, market sentiment, and economic data from TradingView</p>
    </div>
</div>

<!-- Asset Selection Bar -->
<div class="bg-white border-b border-gray-200 sticky top-0 z-10">
    <div class="container mx-auto px-4 py-4">
        <div class="flex flex-wrap justify-center gap-3">
            <button onclick="selectAsset('EURUSD')" class="asset-card" data-symbol="EURUSD">
                <div class="asset-icon">€</div>
                <span>EURUSD</span>
            </button>
            <button onclick="selectAsset('BTCUSD')" class="asset-card" data-symbol="BTCUSD">
                <div class="asset-icon">₿</div>
                <span>BTCUSD</span>
            </button>
            <button onclick="selectAsset('XAUUSD')" class="asset-card active" data-symbol="XAUUSD">
                <div class="asset-icon">🟡</div>
                <span>XAUUSD</span>
            </button>
            <button onclick="selectAsset('IXIC')" class="asset-card" data-symbol="IXIC">
                <div class="asset-icon">📊</div>
                <span>Nasdaq</span>
            </button>
            <button onclick="selectAsset('SPX')" class="asset-card" data-symbol="SPX">
                <div class="asset-icon">📈</div>
                <span>S&P 500</span>
            </button>
            <button onclick="selectAsset('GBPUSD')" class="asset-card" data-symbol="GBPUSD">
                <div class="asset-icon">£</div>
                <span>GBPUSD</span>
            </button>
            <button onclick="selectAsset('USOIL')" class="asset-card" data-symbol="USOIL">
                <div class="asset-icon">🛢️</div>
                <span>Oil</span>
            </button>
        </div>
    </div>
</div>

<!-- Search Section -->
<div class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Search for News & Sentiment</h2>
            <p class="text-gray-600">Enter any stock symbol, forex pair, or commodity to get comprehensive TradingView data</p>
        </div>
        
        <!-- Search Form -->
        <div class="max-w-md mx-auto">
            <div class="flex gap-2">
                <input type="text" 
                       id="newsSearchSymbol" 
                       placeholder="Enter symbol (e.g., AAPL, XAUUSD, EUR/USD)" 
                       class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                       value="XAUUSD">
                <button onclick="searchNews()" 
                        class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors">
                    🔍 Search
                </button>
            </div>
        </div>
        
        <!-- Quick Search Buttons -->
        <div class="flex flex-wrap justify-center gap-3 mt-6">
            <button onclick="quickSearch('XAUUSD')" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors">
                🟡 GOLD (XAUUSD)
            </button>
            <button onclick="quickSearch('EURUSD')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                🔵 EUR/USD
            </button>
            <button onclick="quickSearch('BTCUSD')" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">
                🟠 BTC/USD
            </button>
            <button onclick="quickSearch('SPY')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                🟢 S&P 500 (SPY)
            </button>
            <button onclick="quickSearch('AAPL')" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                📱 Apple (AAPL)
            </button>
        </div>
    </div>
    
    <!-- Main Dashboard Grid -->
    <div class="mb-8">
        <!-- Asset Profile Card -->
        <div class="bg-white rounded-xl shadow-lg p-6 w-full">
            <h3 class="text-xl font-semibold text-gray-900 mb-4" id="profileTitle">XAUUSD Profile</h3>
            <div id="assetProfile" class="h-64">
                <div class="flex items-center justify-center h-full">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-2"></div>
                        <p class="text-gray-500">Loading Profile...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- News Categories Grid -->
    <div class="grid lg:grid-cols-2 gap-6 mb-8">
        <!-- Market News -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">Market News</h3>
            <div id="marketNews" class="h-96">
                <div class="flex items-center justify-center h-full">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-2"></div>
                        <p class="text-gray-500">Loading Market News...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Economic Calendar -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">Economic Calendar</h3>
            <div id="economicCalendar" class="h-96">
                <div class="flex items-center justify-center h-full">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-2"></div>
                        <p class="text-gray-500">Loading Economic Calendar...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSS for Asset Cards -->
<style>
.asset-card {
    @apply flex flex-col items-center gap-2 px-4 py-3 rounded-lg border-2 border-gray-200 hover:border-indigo-400 transition-all duration-200 cursor-pointer;
}

.asset-card.active {
    @apply border-indigo-500 bg-indigo-50;
}

.asset-icon {
    @apply w-8 h-8 rounded-full border-2 border-copper-500 bg-white flex items-center justify-center text-copper-600 font-bold text-lg;
}

.asset-card:hover .asset-icon {
    @apply border-indigo-500 text-indigo-600;
}

.asset-card.active .asset-icon {
    @apply border-indigo-500 text-indigo-600;
}
</style>

<!-- JavaScript for Enhanced News & Sentiment Page -->
<script>
let currentSymbol = 'XAUUSD';

document.addEventListener('DOMContentLoaded', function() {
    console.log('Enhanced News & Sentiment page loaded');
    
    // Initialize with default symbol (XAUUSD)
    initAllWidgets(currentSymbol);
    
    // Set active asset card
    updateActiveAssetCard(currentSymbol);
});

// Asset selection function
function selectAsset(symbol) {
    currentSymbol = symbol;
    document.getElementById('newsSearchSymbol').value = symbol;
    
    // Update active asset card
    updateActiveAssetCard(symbol);
    
    // Initialize all widgets with new symbol
    initAllWidgets(symbol);
}

// Update active asset card styling
function updateActiveAssetCard(symbol) {
    // Remove active class from all cards
    document.querySelectorAll('.asset-card').forEach(card => {
        card.classList.remove('active');
    });
    
    // Add active class to selected card
    const selectedCard = document.querySelector(`[data-symbol="${symbol}"]`);
    if (selectedCard) {
        selectedCard.classList.add('active');
    }
}

// Search function for news and sentiment
function searchNews() {
    const symbol = document.getElementById('newsSearchSymbol').value.trim().toUpperCase();
    if (!symbol) {
        alert('Please enter a valid symbol');
        return;
    }
    
    currentSymbol = symbol;
    console.log(`Searching news and sentiment for: ${symbol}`);
    
    // Update active asset card
    updateActiveAssetCard(symbol);
    
    // Initialize all widgets with new symbol
    initAllWidgets(symbol);
}

// Quick search function
function quickSearch(symbol) {
    document.getElementById('newsSearchSymbol').value = symbol;
    searchNews();
}

// Initialize all widgets
function initAllWidgets(symbol) {
    console.log(`Initializing all widgets for ${symbol}`);
    
    // Show loading state for all widgets
    showLoadingState();
    
    // Initialize each widget
    initAssetProfile(symbol);
    initMarketNews(symbol);
    initEconomicCalendar();
    
    // Update all titles
    updateAllTitles(symbol);
}

// Show loading state for all widgets
function showLoadingState() {
    const widgets = ['assetProfile', 'marketNews', 'economicCalendar'];
    
    widgets.forEach(widgetId => {
        const container = document.getElementById(widgetId);
        if (container) {
            container.innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-2"></div>
                        <p class="text-gray-500">Loading...</p>
                    </div>
                </div>
            `;
        }
    });
}

// Update all titles
function updateAllTitles(symbol) {
    document.getElementById('profileTitle').textContent = `${symbol} Profile`;
}

// Initialize Asset Profile Widget
function initAssetProfile(symbol) {
    console.log(`Initializing Asset Profile for ${symbol}`);
    const container = document.getElementById('assetProfile');
    container.innerHTML = '';
    
    // Create the TradingView Symbol Overview widget
    const script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js';
    script.async = true;
    
    const widgetConfig = {
        "symbols": [
            [symbol, symbol]
        ],
        "chartOnly": false,
        "width": "100%",
        "height": "100%",
        "locale": "en",
        "colorTheme": "light",
        "autosize": true,
        "showVolume": false,
        "showMA": false,
        "hideDateRanges": false,
        "hideMarketStatus": false,
        "hideSymbolLogo": false,
        "scalePosition": "right",
        "scaleMode": "Normal",
        "fontFamily": "-apple-system, BlinkMacSystemFont, Trebuchet MS, Roboto, Ubuntu, sans-serif",
        "fontSize": "10",
        "noTimeScale": false,
        "valuesTracking": "1",
        "changeMode": "price-and-percent",
        "chartType": "area",
        "maLineColor": "#2962FF",
        "maLineWidth": 1,
        "maLength": 9,
        "lineWidth": 2,
        "lineColor": "#2962FF"
    };
    
    script.innerHTML = JSON.stringify(widgetConfig);
    container.appendChild(script);
}

// Initialize Market News Widget
function initMarketNews(symbol) {
    console.log(`Initializing Market News for ${symbol}`);
    const container = document.getElementById('marketNews');
    container.innerHTML = '';
    
    // Create the TradingView News widget with broader market focus
    const script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-timeline.js';
    script.async = true;
    
    const widgetConfig = {
        "colorTheme": "light",
        "isTransparent": false,
        "displayMode": "regular",
        "width": "100%",
        "height": "100%",
        "locale": "en",
        "feedMode": "market",
        "symbolsGroups": [
            {
                "name": "Major Indices",
                "symbols": [
                    {"s": "FOREXCOM:SPXUSD", "d": "S&P 500"},
                    {"s": "FOREXCOM:NSXUSD", "d": "US 100"},
                    {"s": "FOREXCOM:DJI", "d": "Dow 30"}
                ]
            },
            {
                "name": "Commodities",
                "symbols": [
                    {"s": "FOREXCOM:XAUUSD", "d": "Gold"},
                    {"s": "FOREXCOM:XAGUSD", "d": "Silver"},
                    {"s": "FOREXCOM:USOIL", "d": "Crude Oil"}
                ]
            },
            {
                "name": "Major Forex",
                "symbols": [
                    {"s": "FOREXCOM:EURUSD", "d": "EUR/USD"},
                    {"s": "FOREXCOM:GBPUSD", "d": "GBP/USD"},
                    {"s": "FOREXCOM:USDJPY", "d": "USD/JPY"}
                ]
            }
        ]
    };
    
    script.innerHTML = JSON.stringify(widgetConfig);
    container.appendChild(script);
}

// Initialize Economic Calendar Widget
function initEconomicCalendar() {
    console.log('Initializing Economic Calendar Widget');
    const container = document.getElementById('economicCalendar');
    container.innerHTML = '';
    
    // Create the TradingView Economic Calendar widget
    const script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-events.js';
    script.async = true;
    
    const widgetConfig = {
        "colorTheme": "light",
        "isTransparent": false,
        "width": "100%",
        "height": "100%",
        "locale": "en",
        "importanceFilter": "-1,0,1",
        "currencyFilter": "USD,EUR,GBP,JPY,CNY"
    };
    
    script.innerHTML = JSON.stringify(widgetConfig);
    container.appendChild(script);
}

// Add utility functions to window for debugging
window.testNewsPage = function() {
    console.log('Testing Enhanced News Page functionality...');
    searchNews();
};

window.refreshAllWidgets = function() {
    const symbol = document.getElementById('newsSearchSymbol').value || 'XAUUSD';
    console.log(`Refreshing all widgets for ${symbol}`);
    initAllWidgets(symbol);
};

window.selectAsset = selectAsset;
window.searchNews = searchNews;
window.quickSearch = quickSearch;
</script>
{% endblock %}
